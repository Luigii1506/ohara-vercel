generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Card {
  id               Int             @id @default(autoincrement())
  src              String
  imageKey         String?
  name             String
  cost             String?
  power            String?
  attribute        String?
  counter          String?
  category         String
  life             String?
  rarity           String?
  illustrator      String?
  alternateArt     String?
  status           String?
  triggerCard      String?
  code             String
  setCode          String
  isFirstEdition   Boolean
  uuid             String          @unique @default(uuid())
  createdAt        DateTime?       @default(now())
  updatedAt        DateTime?       @updatedAt
  tcgUrl           String?         @default("")
  alias            String?         @default("")
  order            String          @default("0")
  isPro            Boolean         @default(false)
  region           String?
  baseCardId       Int?            // NULL si es carta base, ID de la base si es alternativa
  baseCard         Card?           @relation("CardAlternates", fields: [baseCardId], references: [id], onDelete: Cascade)
  colors           CardColor[]
  conditions       CardCondition[]
  effects          CardEffect[]
  listings         CardListing[]
  priceLogs        CardPriceLog[]
  rulings          CardRuling[]
  sets             CardSet[]
  texts            CardText[]
  types            CardType[]
  DeckCard         DeckCard[]
  opponentGameLogs GameLog[]       @relation("OpponentLeader")
  GameLogCard      GameLogCard[]
  userListCards    UserListCard[]
  alternateCards   Card[]          @relation("CardAlternates") // Las alternativas de esta carta base

  @@index([baseCardId]) // √çndice para b√∫squedas r√°pidas
  @@index([code, isFirstEdition]) // √çndice compuesto para buscar cartas base por code
}

model Deck {
  id             Int        @id @default(autoincrement())
  name           String
  createdAt      DateTime?  @default(now())
  updatedAt      DateTime?  @updatedAt
  originalDeckId Int?
  uniqueUrl      String     @unique
  description    String?    @default("")
  userId         Int?
  originalDeck   Deck?      @relation("OriginalDeck", fields: [originalDeckId], references: [id])
  forks          Deck[]     @relation("OriginalDeck")
  user           User?      @relation(fields: [userId], references: [id])
  deckCards      DeckCard[]
  gameLogs       GameLog[]

  @@index([originalDeckId])
  @@index([userId])
}

model DeckCard {
  id       Int  @id @default(autoincrement())
  deckId   Int
  cardId   Int
  quantity Int  @default(1)
  card     Card @relation(fields: [cardId], references: [id], onDelete: Cascade)
  deck     Deck @relation(fields: [deckId], references: [id])

  @@index([cardId])
  @@index([deckId])
}

model GameLog {
  id               Int           @id @default(autoincrement())
  userId           Int
  deckId           Int
  opponentLeaderId Int
  isWin            Boolean
  wentFirst        Boolean
  opponentName     String?
  comments         String?       @db.Text
  playedAt         DateTime      @default(now())
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deck             Deck          @relation(fields: [deckId], references: [id], onDelete: Cascade)
  opponentLeader   Card          @relation("OpponentLeader", fields: [opponentLeaderId], references: [id])
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  finalHandCards   GameLogCard[]

  @@index([deckId])
  @@index([opponentLeaderId])
  @@index([userId])
}

model GameLogCard {
  id        Int     @id @default(autoincrement())
  gameLogId Int
  cardId    Int
  card      Card    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  gameLog   GameLog @relation(fields: [gameLogId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([gameLogId])
}

model CardRuling {
  id       Int    @id @default(autoincrement())
  cardId   Int
  question String @db.Text
  answer   String @db.Text
  card     Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model CardCondition {
  id        Int    @id @default(autoincrement())
  cardId    Int
  condition String
  card      Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model CardType {
  id     Int    @id @default(autoincrement())
  cardId Int
  type   String
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model CardColor {
  id     Int    @id @default(autoincrement())
  cardId Int
  color  String
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model CardEffect {
  id     Int    @id @default(autoincrement())
  cardId Int
  effect String
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model CardText {
  id     Int    @id @default(autoincrement())
  cardId Int
  text   String @db.Text
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model User {
  id                Int               @id @default(autoincrement())
  email             String            @unique
  name              String
  createdAt         DateTime?         @default(now()) @map("createdAt")
  updatedAt         DateTime?         @updatedAt @map("updatedAt")
  role              String            @default("USER")
  emailVerified     DateTime?
  image             String?
  uuid              String            @unique @default(uuid())
  accounts          Account[]
  billingAddresses  BillingAddress[]
  cardListings      CardListing[]     @relation("SellerListings")
  CardPriceLog      CardPriceLog[]
  cart              Cart?
  decks             Deck[]
  gameLogs          GameLog[]
  buyerOrders       Order[]           @relation("BuyerOrders")
  sellerSales       Order[]           @relation("SellerSales")
  products          Product[]         @relation("SellerProducts")
  reviews           Review[]
  sellerProfile     SellerProfile?
  sessions          Session[]
  shippingAddresses ShippingAddress[]
  lists             UserList[]
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String  @unique
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model UserList {
  id           Int                 @id @default(autoincrement())
  userId       Int
  name         String
  description  String?
  isOrdered    Boolean             @default(false)
  isDeletable  Boolean             @default(true)
  isCollection Boolean             @default(false)
  maxRows      Int?
  maxColumns   Int?
  totalPages   Int                 @default(1)
  color        String?
  isPublic     Boolean             @default(false)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  cards        UserListCard[]
  backcards    UserListBackcard[] // üé¥ Relaci√≥n con backcards

  @@unique([userId, name])
  @@index([userId, isPublic])
  @@index([userId, isCollection])
}

model UserListCard {
  id        Int      @id @default(autoincrement())
  listId    Int
  cardId    Int
  quantity  Int      @default(1)
  sortOrder Int?
  page      Int?
  row       Int?
  column    Int?
  notes     String?
  condition String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  list      UserList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([listId, page, row, column], name: "unique_physical_position")
  @@index([listId, cardId])
  @@index([listId, sortOrder])
  @@index([cardId])
}

// üé¥ Modelo para almacenar posiciones de backcard
model UserListBackcard {
  id        Int      @id @default(autoincrement())
  listId    Int
  page      Int
  row       Int
  column    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  list      UserList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([listId, page, row, column], name: "unique_backcard_position")
  @@index([listId])
}

model Event {
  id        Int        @id @default(autoincrement())
  name      String
  eventDate DateTime   @map("event_date")
  location  String
  createdAt DateTime?  @default(now())
  updatedAt DateTime?  @updatedAt
  sets      EventSet[]
}

model Set {
  id          Int        @id @default(autoincrement())
  image       String
  title       String
  code        String?
  releaseDate DateTime   @map("release_date")
  isOpen      Boolean    @default(false) @map("is_open")
  createdAt   DateTime?  @default(now()) @map("created_at")
  updatedAt   DateTime?  @updatedAt @map("updated_at")
  version     String?
  cards       CardSet[]
  events      EventSet[]
}

model EventSet {
  eventId Int
  setId   Int
  event   Event @relation(fields: [eventId], references: [id])
  set     Set   @relation(fields: [setId], references: [id])

  @@id([eventId, setId])
  @@index([setId])
}

model CardSet {
  cardId Int
  setId  Int
  id     Int  @id @default(autoincrement())
  card   Card @relation(fields: [cardId], references: [id], onDelete: Cascade)
  set    Set  @relation(fields: [setId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([setId])
}

model CardPriceLog {
  id            Int      @id @default(autoincrement())
  cardId        Int
  previousPrice Float
  newPrice      Float
  userId        Int?
  changedAt     DateTime @default(now())
  card          Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id])

  @@index([cardId])
  @@index([userId])
}

model CardListing {
  id                Int         @id @default(autoincrement())
  uuid              String      @unique @default(uuid())
  cardId            Int
  sellerId          Int
  price             Decimal
  stock             Int
  conditionForSale  String
  sku               String?     @unique
  isActive          Boolean     @default(true)
  isDraft           Boolean     @default(false)
  isFeatured        Boolean     @default(false)
  lowStockThreshold Int         @default(5)
  listingDate       DateTime    @default(now())
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  card              Card        @relation(fields: [cardId], references: [id], onDelete: Cascade)
  seller            User        @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)
  cartItems         CartItem[]
  orderItems        OrderItem[]
  reviews           Review[]

  @@index([sellerId, isActive])
  @@index([cardId, sellerId])
  @@index([isActive, isFeatured])
}

model Product {
  id                Int         @id @default(autoincrement())
  uuid              String      @unique @default(uuid())
  name              String
  description       String?     @db.Text
  price             Decimal
  stock             Int
  sku               String?     @unique
  imageUrl          String?
  categoryId        Int?
  sellerId          Int
  isActive          Boolean     @default(true)
  isDraft           Boolean     @default(false)
  isFeatured        Boolean     @default(false)
  lowStockThreshold Int?        @default(5)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  cartItems         CartItem[]
  orderItems        OrderItem[]
  seller            User        @relation("SellerProducts", fields: [sellerId], references: [id])
  reviews           Review[]

  @@index([sellerId])
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
}

model CartItem {
  id              Int          @id @default(autoincrement())
  cartId          Int
  cardListingId   Int?
  productId       Int?
  quantity        Int
  priceAtAddition Decimal
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  cardListing     CardListing? @relation(fields: [cardListingId], references: [id])
  cart            Cart         @relation(fields: [cartId], references: [id])
  product         Product?     @relation(fields: [productId], references: [id])

  @@unique([cartId, cardListingId, productId])
  @@index([cardListingId])
  @@index([productId])
}

model Order {
  id                      Int             @id @default(autoincrement())
  uuid                    String          @unique @default(uuid())
  buyerId                 Int
  sellerId                Int?
  totalAmount             Decimal
  subtotal                Decimal
  shippingCost            Decimal
  taxAmount               Decimal
  discountAmount          Decimal         @default(0.000000000000000000000000000000)
  status                  OrderStatus     @default(PENDING)
  trackingNumber          String?
  shippingCarrier         String?
  shippingAddressId       Int
  billingAddressId        Int
  stripePaymentIntentId   String?         @unique
  stripeCheckoutSessionId String?         @unique
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  billingAddress          BillingAddress  @relation(fields: [billingAddressId], references: [id])
  buyer                   User            @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller                  User?           @relation("SellerSales", fields: [sellerId], references: [id])
  shippingAddress         ShippingAddress @relation(fields: [shippingAddressId], references: [id])
  orderItems              OrderItem[]

  @@index([billingAddressId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([shippingAddressId])
}

model OrderItem {
  id                  Int          @id @default(autoincrement())
  orderId             Int
  cardListingId       Int?
  productId           Int?
  quantity            Int
  priceAtPurchase     Decimal
  conditionAtPurchase String?
  cardListing         CardListing? @relation(fields: [cardListingId], references: [id])
  order               Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product             Product?     @relation(fields: [productId], references: [id])

  @@index([cardListingId])
  @@index([orderId])
  @@index([productId])
}

model ShippingAddress {
  id        Int      @id @default(autoincrement())
  userId    Int
  fullName  String
  address1  String
  address2  String?
  city      String
  state     String
  zipCode   String
  country   String
  phone     String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model BillingAddress {
  id        Int      @id @default(autoincrement())
  userId    Int
  fullName  String
  address1  String
  address2  String?
  city      String
  state     String
  zipCode   String
  country   String
  phone     String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  orders    Order[]

  @@index([userId])
}

model SellerProfile {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  stripeAccountId String?  @unique
  bio             String?  @db.Text
  storeName       String?  @unique
  storeUrl        String?
  isActive        Boolean  @default(false)
  rating          Float?   @default(0)
  reviewsCount    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  reviews         Review[]
  user            User     @relation(fields: [userId], references: [id])
}

model Review {
  id              Int            @id @default(autoincrement())
  userId          Int
  cardListingId   Int?
  productId       Int?
  sellerProfileId Int?
  rating          Int            @db.SmallInt
  comment         String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  cardListing     CardListing?   @relation(fields: [cardListingId], references: [id])
  product         Product?       @relation(fields: [productId], references: [id])
  sellerProfile   SellerProfile? @relation(fields: [sellerProfileId], references: [id])
  user            User           @relation(fields: [userId], references: [id])

  @@index([cardListingId])
  @@index([productId])
  @@index([sellerProfileId])
  @@index([userId])
}

enum Role {
  ADMIN
  USER
  SELLER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
  PARTIALLY_REFUNDED
}
